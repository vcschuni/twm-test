In addition to the set-up shown in plugin-config-example.txt, ensure the following required changes have been made to enable TWM editing.

DataBase
========

For each database environment (DEV, TST, and PRD) the gt_pk_metadata table requred. If it does not yet exist, create it as follows:

-- Primary key management for GeoServer
CREATE TABLE gt_pk_metadata (
  table_schema VARCHAR2(32) NOT NULL,
  table_name VARCHAR2(32) NOT NULL,
  pk_column VARCHAR2(32) NOT NULL,
  pk_column_idx NUMBER(38),
  pk_policy VARCHAR2(32),
  pk_sequence VARCHAR2(64),
  constraint  chk_pk_policy check (pk_policy in ('sequence', 'assigned', 'autogenerated')));

CREATE UNIQUE INDEX gt_pk_metadata_table_idx01 ON gt_pk_metadata (table_schema, table_name, pk_column);

COMMENT ON TABLE gt_pk_metadata IS 'Instructs GeoServer how to locate the next value for the key in case a new feature needs to be generated (WFS insert operation)';
COMMENT ON COLUMN gt_pk_metadata.table_schema IS 'Name of the database schema in which the table is located.';
COMMENT ON COLUMN gt_pk_metadata.table_name IS 'Name of the table or view to be published';
COMMENT ON COLUMN gt_pk_metadata.pk_column IS 'Name of a column used to form the feature IDs';
COMMENT ON COLUMN gt_pk_metadata.pk_column_idx IS 'Index of the column in a multi-column key, else NULL. In case multi column keys are needed, multiple records with the same table schema and table name will be used.';
COMMENT ON COLUMN gt_pk_metadata.pk_policy IS 'The new value generation policy, used in case a new feature needs to be added in the table (following a WFS-T insert operation).';
COMMENT ON COLUMN gt_pk_metadata.pk_sequence IS 'The name of the database sequence to be used when generating a new value for the pk_column.';

Database changes from TWM edits are made not by the user but by a proxy account which has been given permissions b

-- Grant roles to PK metadata table 
GRANT SELECT ON gt_pk_metadata TO APP_ISS_READWRITE;

For each table you want to edit ensure it has: 
1) A primary key defined
2) A sequence to generate new primary keys
3) An insert trigger to assign those keys
4) Grants to the editing proxy account to perform SELECT, UPDATE, INSERT and DELETE as required for your application. This is done by the DBA group.
Note, in APP_ISS the account APP_ISS_PROXY_OGS_EDIT has SELECT, INSERT, UPDATE, DELETE on all APP_ISS tables and SELECT on all views.

-- Update Primary Key metadata for your table. This example for ISS_FEATURES
INSERT INTO gt_pk_metadata (table_schema, table_name, pk_column, pk_column_idx, pk_policy, pk_sequence) values ('ISS','ISS_FEATURES','FEATURE_ID',NULL,'autogenerated','APP_ISS.ISS_FEATURES_FEATURE_ID_SEQ');

-- Grant access to your table's PK sequence
GRANT SELECT ON ISS_FEATURES_FEATURE_ID_SEQ TO APP_ISS_READWRITE;

The ISS_FEATURES table in https://svn.th.gov.bc.ca/FME/trunk/model/ISS/ISS_FEATURES.sql details above DataBase steps.


WebADE
======

Security of the database table is managed through a combination of settings in the WebADE database and settings in the GeoServer middle tier.
As noted above, the proxy account may have wide ranging privileges while the editing applications will need to allow only select people or groups that power.
Below is the process to set-up WebADE for TWM editing.
OGS is the APPLICATION in WebADE under which all spatial editing privileges will be grouped.
The script below creates two roles, one for Read Only access and one for Editing access.
Privileges, or ROLES are grouped into PROFILES for convenience.
PROFILES will be further granted to individuals or groups through the ADAM application, discussed later.

-- WebADE setup for the FOO application in APP_ISS
-- does 9 inserts

-- READ ROLE
insert into APPLICATION_ROLE (APPLICATION_ACRONYM, ROLE_NAME, ROLE_DEFINITION) values ('OGS', 'ISS_FOO_R', 'ISS FOO read access to spatial data.');

-- WRITE ROLE
insert into APPLICATION_ROLE (APPLICATION_ACRONYM, ROLE_NAME, ROLE_DEFINITION) values ('OGS', 'ISS_FOO_W', 'ISS FOO spatial write access.');

-- READ ONLY PROFILE
INSERT INTO AUTHORIZATION_PROFILE (AUTHORIZATION_PROFILE_ID, PROFILE_NAME, PROFILE_DESCRIPTION, SECURE_BY_ORGANIZATION_IND, REVISION_COUNT) VALUES (AUTH_PROFILE_SEQ.NEXTVAL,'ISS_FOO_OGS_READ','Read access to ISS FOO spatial data','N',1);

insert into PROFILE_ROLE_LINK (AUTHORIZATION_PROFILE_ID, APPLICATION_ACRONYM, ROLE_NAME) SELECT AUTHORIZATION_PROFILE_ID,'OGS','ISS_FOO_R' FROM AUTHORIZATION_PROFILE WHERE PROFILE_NAME = 'ISS_FOO_OGS_READ';

INSERT INTO AUTH_PROFILE_USR_LINK
   (USER_TYPE_CODE, AUTHORIZATION_PROFILE_ID)
 VALUES
   ('GOV', (SELECT AUTHORIZATION_PROFILE_ID FROM AUTHORIZATION_PROFILE WHERE PROFILE_NAME = 'ISS_FOO_OGS_READ'));


-- READ AND WRITE PROFILE
INSERT INTO AUTHORIZATION_PROFILE (AUTHORIZATION_PROFILE_ID,PROFILE_NAME, PROFILE_DESCRIPTION, SECURE_BY_ORGANIZATION_IND, REVISION_COUNT) VALUES (AUTH_PROFILE_SEQ.NEXTVAL,'ISS_FOO_OGS_ADMIN','Admin access to ISS FOO spatial data','N',1);

insert into PROFILE_ROLE_LINK (AUTHORIZATION_PROFILE_ID, APPLICATION_ACRONYM, ROLE_NAME) SELECT AUTHORIZATION_PROFILE_ID,'OGS','ISS_FOO_W' FROM AUTHORIZATION_PROFILE WHERE PROFILE_NAME = 'ISS_FOO_OGS_ADMIN';

insert into PROFILE_ROLE_LINK (AUTHORIZATION_PROFILE_ID, APPLICATION_ACRONYM, ROLE_NAME) SELECT AUTHORIZATION_PROFILE_ID,'OGS','ISS_FOO_R' FROM AUTHORIZATION_PROFILE WHERE PROFILE_NAME = 'ISS_FOO_OGS_ADMIN';
INSERT INTO AUTH_PROFILE_USR_LINK
   (USER_TYPE_CODE, AUTHORIZATION_PROFILE_ID)
 VALUES
   ('GOV', (SELECT AUTHORIZATION_PROFILE_ID FROM AUTHORIZATION_PROFILE WHERE PROFILE_NAME = 'ISS_FOO_OGS_ADMIN')); 
   
There are three WebADE databases, currently DEV04, TST04 and PRD05.
As the editing application is migrated through each environment the WebADE scripts must be submitted as tickets to the TECHOPS queue for the appropriate database.


SiteMinder
==========

SiteMinder is the ministry's authentication service.
TWM URLs are protected by two instances of SiteMinder, TST and PRD.

dev-motigeo.th.gov.bc.ca
tst-motigeo.th.gov.bc.ca
motigeo.th.gov.bc.ca
Of these, the first two are protected by TST SiteMinder, and the third by PRD SiteMinder.

The first time you visit a SiteMinder protected URL you will be re-directed to the Common Logon Page (CLP).
Once authenticated your browser keeps a SiteMinder Session comprised of Cookies and special HTTP headers.
Switching between TST SiteMinder and PRD SiteMinder URLs will require re-authentication.
 
Authenticating with SiteMinder is the first step to being able to use a secure TWM editing application.


GeoServer
=========

All internal GeoServer instances are configured so that no user has edit capabilities on any layer unless EXPLICITLY granted. 
The ministry's internal GeoServer instances enforce access permissions on every request to its services.
On each request, GeoServer determines the requestors identity from their SiteMinder session.
Next GeoServer queries the WebADE database to obtain the roles granted that user and only responds with layers allowed by its own data security settings.
 
The following are required in GeoServer's configuration for an editing application.

A DataStore which connects using the editing proxy account.
Expose primary keys checked
Primary key metadata table: GT_PK_METADATA

An editable Layer based on the DataBase table(s) created above.

The WRITE role, ISS_FOO_W above, assigned in Data Security to the editable layer.

There are three internal GeoServer instances, DEV, TST and PRD.
As the editing application is migrated through each environment the above changes must be made to the appropriate GeoServer instance.

Where an application has more than three environments, such as User Acceptance Testing (UAT), GeoServer namespaces are given an environment specific suffix.
For example, the BAR application:
DataBase	GeoServer	Namespace
DEV			DEV			bar_dev
TST			DEV			bar_tst
UAT			TST			bar_uat
PRD			PRD			bar_prd	

ADAM
====

Authority Delegation And Management (ADAM) is the web interface for assigning WebADE PROFILES to users or groups of users as well as delegate that ability to others.
The Spatial Team will have access to do this in the DEV and TST versions of ADAM.
Assignments in the PRD version of ADAM must be done by the IMB's Client Services group.

Once the DBA group have completed the WebADE inserts visit the appropriate ADAM web page
https://devoas4.apps.th.gov.bc.ca/adam/
https://tstoas5.apps.th.gov.bc.ca/adam/

1) Delegate the profile to yourself, or whoever will perform the authorizations later, by clickiing New Delegation from the left hand menu and using the drop-down to select that profile.
	On the form that appears enter your IDIR and ensure you check Effective, Expires and Enable. 
	If you are delegating to a consultant set the Expires to the end date of their contract.
	Create the delegation and confirm.
2) Authorize the user who will do the editing by clicking New Authorization from the left hand menu and using the drop-down to select that profile.
	On the form that appears enter your IDIR, or that of whoever will do the editing, and ensure you check Effective, Expires and Enable. 
	A Group can be authorized on this form as well but it is unlikely edit permissions would be assigned to such a wide audience.
	Add the authorization and confirm.
	
Both Delegations and Authorization can be done in Batches as well if you need to assign to multiple people or assign multiple profiles.

For PRD let Client Services know who on the business side is responsible for allowing access to editing.

Questions?
==========

Please contact IMB's Team Spatial.

