class CRTIdentify2Popup {

	/**
	 * Function: constructor
	 * @param () none
	 * @returns () nothing
	 * Function that initializes the class
	 */
	constructor() {
		this.name = "CRTIdentify2Popup";
		this.version = 1.0;
		this.author = "Volker Schunicht, modified by Peter Spry";
		this.pcfg = getPluginConfig(this.name);
		this.featureTemplateFile = "application/plugins/CRTIdentify2Popup/feature-template.html";
		this.aggregatedLayerName = "CRTData"; // Layer name in app-config.js
		this.featureTemplate = "";
		this.featureStore = [];
		this.popupContent = $("<div></div>");
		this.addPlugin();
		this.identifyInProgress = false;
		this.clickEventCoordinate;
	}
	
	/**
	 * Function: resultsAggregator
	 * @param (object) layer
	 * @param (object) features
	 * @returns () nothing
	 * Function that aggregates the results from each layer searched
	 */
	resultsAggregator(layer, features) {
		
		// Iterate through features
		$.each(features, function(index, feature) {
			
			// Get the geometry field name
			var geometryFieldName = (feature.hasOwnProperty("geometry_name")) ? feature.geometry_name : "";
			
			// Create and add the feature to the feature store
			var olFeature = convertToOpenLayersFeature("GeoJSON", feature);
			if (olFeature) {
				app.plugins.CRTIdentify2Popup.featureStore.push(olFeature);
			} else {
				app.plugins.CRTIdentify2Popup.featureStore.push(feature);
			}
			var featureStoreId = app.plugins.CRTIdentify2Popup.featureStore.length - 1;
			
			// CaRT popup identify will NOT show layer title, only Project number and name.
			var featureTitle = "";
			if (layer.get("fields")) {
				$.each(layer.get("fields"), function(index, configField) {
					if (configField.name) {
						$.each(feature.properties, function(fieldName, fieldValue) {
							if (configField.name == fieldName) {
								if (configField.title) {
									featureTitle += "<i>"+fieldValue+"</i> - ";
								} 
							}
						});
					}
				});
			} else {
				featureTitle += " [" + (index + 1) + "]";
			}
			featureTitle = featureTitle.slice(0, -3);

			// Make a clone of the feature template
			var clone = app.plugins.CRTIdentify2Popup.featureTemplate.clone(true);
			
			// Link (attribute) the feature ID to the table
			clone.attr("featureStoreId", featureStoreId);
			
			// Insert feature title into the clone
			clone.find(".ci2p-feature-title").append(featureTitle);
			
			// Hide feature table (clone) if its not the first one
			if (featureStoreId > 0 ) clone.hide();
			
			// Enable the navigate to button if the plugin exists
			if (app.plugins.DynamicRouter) clone.find(".CRTIdentify2PopupNavigateTo").show();

			// If the layer fields ARE NOT configured, add them in raw
			if (!layer.get("fields")) {
				$.each(feature.properties, function(fieldName, fieldValue) {
					if (!["BBOX", geometryFieldName.toUpperCase()].includes(fieldName.toUpperCase())) { 
						clone.find("tbody").first().append("<tr><td class='ci2p-feature-field-name'>"+fieldName+":</td><td>"+fieldValue+"</td></tr>");
					}
				});
			}
			
			// If the layer fields ARE configured, honour the settings
			if (layer.get("fields")) {
				$.each(layer.get("fields"), function(index, configField) {
					if (configField.showInIdentify) {
						// Build the fieldIndex
						var fieldValueIndex = featureStoreId + "-" + configField.name + "-value";
						
						// Get the field name and field value
						var fieldName = configField.name;
						var fieldValue = feature.properties[configField.name];
										
						// Apply custom field name and field value transforms (if configured)
						if (configField.nameTransform) fieldName = configField.nameTransform(fieldName);
						if (configField.valueTransform) fieldValue = configField.valueTransform(fieldValue, feature);
			
						// If fieldValue is a boolean false, then don't show field record at all
						if (fieldValue === false) return;
							
						// Append field value to existing field record (if configured)
						if (configField.appendToField) {
							var appendToFieldIndex = featureStoreId + "-" + configField.appendToField + "-value";
							var target = clone.find("[fieldIndex='"+appendToFieldIndex+"']")
							target.append(fieldValue);
						
						// Add field name and/or value as configured
						} else {
							// If fieldName is a boolean false, then don't show field name
							if (fieldName === false) {
								clone.find("tbody").first().append("<tr><td fieldIndex='"+fieldValueIndex+"' colspan='2'>"+fieldValue+"</td></tr>");
							} else {
								clone.find("tbody").first().append("<tr><td class='ci2p-feature-field-name'>"+fieldName+"</td><td fieldIndex='"+fieldValueIndex+"'>"+fieldValue+"</td></tr>");
							}
						}
					} // if showInIdentify
				
				}); // end forEach
			}
			
			// Append clone to the popup content
			app.plugins.CRTIdentify2Popup.popupContent.append(clone);
		});
	}

	/**
	 * Function: registerResultEventHandlers
	 * @param () none
	 * @returns () nothing
	 * Function that registers each result's event handlers
	 */
	registerResultEventHandlers() {
		// Register all of the navigate to click event handlers
		$(".CRTIdentify2PopupNavigateTo").on("click", function(e) {
			// Remove all pre-existing way points
			$(".dr-way-point").remove();
			
			// Define the start and end elements
			var locationStartInput = $("#dr-start-point .dr-location-input");
			var locationEndInput = $("#dr-end-point .dr-location-input");
			
			// Clear both the start and end elements
			locationStartInput.val("");
			locationStartInput.attr("longitude", null);
			locationStartInput.attr("latitude", null);
			locationEndInput.val("");
			locationEndInput.attr("longitude", null);
			locationEndInput.attr("latitude", null);
			
			// Add device current location into the start location input
			app.plugins.DynamicRouter.registerDeviceLocation(locationStartInput);
			
			// Add current feature location into the end location input
			var featureStoreId = $(this).closest("table").attr("featureStoreId");
			app.plugins.DynamicRouter.registerFeatureLocation(locationEndInput, app.plugins.CRTIdentify2Popup.featureStore[featureStoreId]);
			
			// Close the popup
			closePopup();
			
			// Show the router tab
			activateSidebarTab(app.plugins.DynamicRouter.tabNav);

			// Show sidebar immediately if desktop
			if (!isMobile()) showSidebar();
		});
		
	}
	
	/**
	 * Function: showResult
	 * @param () none
	 * @returns () nothing
	 * Function that shows the result (in a paginated popup if required)
	 */
	showResult() {
		// Reset identify progress status
		app.plugins.CRTIdentify2Popup.identifyInProgress = false;
		
		// Reset cursor
		$("#map").css("cursor", app.defaultMapCursor);
		
		// Bail if no results
		if (app.plugins.CRTIdentify2Popup.featureStore.length == 0) return;
				
		// Add paging div if required	
		if (app.plugins.CRTIdentify2Popup.featureStore.length > 1) {
			var pager = $("<div onselectstart='return false'></div>");
			pager.attr("id", "ci2p-paging");
			pager.attr("currentFeatureStoreId", 0);
			pager.attr("maxFeatureStoreId", (app.plugins.CRTIdentify2Popup.featureStore.length - 1));
			pager.append("<span class='oi oi-chevron-left ci2p-page-left' title='Previous' onclick='app.plugins.CRTIdentify2Popup.switchPage(-1)'></span>");
			pager.append("<span id='ci2p-paging-text'>1 of " + app.plugins.CRTIdentify2Popup.featureStore.length + "</span>");
			pager.append("<span class='oi oi-chevron-right ci2p-page-right' title='Next' onclick='app.plugins.CRTIdentify2Popup.switchPage(1)'></span>");
			app.plugins.CRTIdentify2Popup.popupContent.append(pager);
		}
		
		// Get the first feature (this is to base the highlight and popup location on)
		var feature = app.plugins.CRTIdentify2Popup.featureStore[0];
		
		// Define popup location on map
		var popupLocation = app.plugins.CRTIdentify2Popup.clickEventCoordinate;
		
		// Highlight the current feature
		highlightFeature(feature);
		
		// Adjust popup content dimensions
		app.plugins.CRTIdentify2Popup.adjustPopupContent();
			
		// Show the popup
		showPopup(popupLocation, app.plugins.CRTIdentify2Popup.popupContent);
		
		// Register button handlers
		app.plugins.CRTIdentify2Popup.registerResultEventHandlers();
	}
	
	/**
	 * Function: switchPage
	 * @param (integer) direction
	 * @returns () nothing
	 * Function that switches
	 */
	switchPage(direction) {
		// Determine which record to switch to
		var currentFeatureStoreId = parseInt($("#ci2p-paging").attr("currentFeatureStoreId"));
		var maxFeatureStoreId = parseInt($("#ci2p-paging").attr("maxFeatureStoreId"));
		var newCurrentFeatureStoreId = currentFeatureStoreId + direction;
		if (newCurrentFeatureStoreId > maxFeatureStoreId) newCurrentFeatureStoreId = 0;
		if (newCurrentFeatureStoreId < 0) newCurrentFeatureStoreId = (app.plugins.CRTIdentify2Popup.featureStore.length - 1);
		
		// Update the new current record
		$("#ci2p-paging").attr("currentFeatureStoreId", newCurrentFeatureStoreId);
		
		// Update display
		$("#ci2p-paging-text").html((newCurrentFeatureStoreId + 1) + " of " + app.plugins.CRTIdentify2Popup.featureStore.length);
		
		// Get the feature
		var feature = app.plugins.CRTIdentify2Popup.featureStore[newCurrentFeatureStoreId];
		
		// Define popup location on map
		var popupLocation = app.plugins.CRTIdentify2Popup.clickEventCoordinate;


		// Highlight the current feature
		highlightFeature(feature);
		
		// Only useful for map identify, not for CRTreporter 
		if ($(".mfw-window :visible").length == 0) {
			// Reposition popup to feature center
			setTimeout(function(){
				app.popupOverlay.setPosition(undefined);
				app.popupOverlay.setPosition(popupLocation);
				doLayout();
			}, 50);
		}
		
		// Loop through all of the feature tables.  Show the active one, hide the rest.
		$.each($('.ci2p-feature-table'), function(index, element) { 
			if ($(element).attr("featureStoreId") == newCurrentFeatureStoreId) {
				$(element).show();
			} else {
				$(element).hide();
			}
		});
	}
	
	/**
	 * Function: clear
	 * @param () none
	 * @returns () nothing
	 * Function that clears any previous results
	 */
	clear() {
		// Reset the popup content
		app.plugins.CRTIdentify2Popup.popupContent = $("<div></div>");
		
		// Reset the feature store
		app.plugins.CRTIdentify2Popup.featureStore = [];
	}
	
	/**
	 * Function: aggregateFeatures
	 * @param (object) feature array
	 * @returns (object) feature array with one feature per project
	 * Function that aggregates features by project
	 */	
	aggregateFeatures(features) {
		// create a feature array with aggregated properties (per segment)
		var aggregatedFeatures=[]
		var byProject = d3.flatGroup(features, d => d.properties.PROJECT_ID, d => d.properties.PROJECT_NUMBER, d => d.properties.ANNCMENT_VALUE, d => d.properties.C035_VALUE, d => d.properties.ESTIMATED_VALUE);
		// Project value is first Announced Value, but if null, it is C035 Value, but if null it is Estimated Value
		byProject.forEach(function(item){
			var feat = item[5][0];
			var value = item[2];
			var valueSource = " (Announced)";
			if ((value === null)||(value==0)) {
				value = item[3];
				valueSource = " (C035)";
			};
			if ((value === null)||(value==0))  {
				value = item[4]
				valueSource = " (Estimated)";
			};
			if ((value === null)||(value==0))  {value = 0};
			var prettyValue = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
			prettyValue = prettyValue.slice(0, -3) + valueSource;
			feat.properties = {
				PROJECT_ID:feat.properties.PROJECT_ID,
				PROJECT_NUMBER:feat.properties.PROJECT_NUMBER,
				PROJECT_NAME:feat.properties.PROJECT_NAME,
				PRJ_DESCRIPTION:feat.properties.PRJ_DESCRIPTION,
				PROJECT_MGR_DESC:feat.properties.PROJECT_MGR_DESC,	
				FIN_TARGET_SERVICE_LINE_DESC:feat.properties.FIN_TARGET_SERVICE_LINE_DESC,
				PRJ_VALUE:prettyValue,
				REGION_NUMBER: feat.properties.REGION_NUMBER,
				REGION_NAME: feat.properties.REGION_NAME,
				FIN_TARGET_PRG_ELEMENT_DESCRIPTION: feat.properties.FIN_TARGET_PRG_ELEMENT_DESCRIPTION
			};
			aggregatedFeatures.push(feat);
		});
	
		return aggregatedFeatures;
	}
	
	/**
	 * Function: identify
	 * @param (object) event
	 * @returns () nothing
	 * Function that searches for features under click location
	 */
	identify(event) {
		// Bail if another identify is in progress
		if (app.plugins.CRTIdentify2Popup.identifyInProgress) return;
		
		// Bail if the chart is visible
		if ($(".mfw-window :visible").length > 0) return;
		
		// Store the click event coordinate for later use
		app.plugins.CRTIdentify2Popup.clickEventCoordinate = event.coordinate;
		
		// Close existing popup if exists
		closePopup();
		
		// Clear any previous results
		app.plugins.CRTIdentify2Popup.clear();
		
		// Define misc variables
		var layersToSearchCount = 0;
		var layerSearchCompletedCount = 0;
		
		// Define the callback function that runs the aggregator after each layer returns a result
		var callback = function(layer, features){
			layerSearchCompletedCount++;
			if (layer.get("name")==app.plugins.CRTIdentify2Popup.aggregatedLayerName) { // special treatment of CaRT Data
				features = app.plugins.CRTIdentify2Popup.aggregateFeatures(features);
			}
			if (features.length > 0) app.plugins.CRTIdentify2Popup.resultsAggregator(layer, features);
			if (layerSearchCompletedCount >= layersToSearchCount) app.plugins.CRTIdentify2Popup.showResult();
		}
		
		// Determine how many layers there are to search
		$.each(app.map.getLayers().getArray(), function(index, layer) {
			// Determine if layer has a "prevent identify" configured
			var preventIdentify = layer.get("preventIdentify") ? layer.get("preventIdentify") : false;
			
			// Vector layers
			if (layer.get("visible") === true && preventIdentify === false && layer.get("title") && layer instanceof ol.layer.Vector ) {
				layersToSearchCount++;
			}
			
			// WMS layers
			if (layer.get("visible") === true && preventIdentify === false && typeof layer.getSource().getFeatureInfoUrl == "function") {
				layersToSearchCount++;
			}
		});
		
		// If there are no layers to search, run the result compiler to show no results
		if (layersToSearchCount == 0) {
			callback({}, []);
			return;
		}
		
		// Toggle that identify is in progress
		app.plugins.CRTIdentify2Popup.identifyInProgress = true;
		
		// Show working cursor
		$("#map").css("cursor", "wait");

		// Loop through all of the map layers
		$.each(app.map.getLayers().getArray(), function(index, layer) {
			
			// Determine if layer has a "prevent identify" configured.  If so, skip layer.
			var preventIdentify = layer.get("preventIdentify") ? layer.get("preventIdentify") : false;
			if (preventIdentify) return;
			
			// Vector :: Perform a GetFeature
			if (layer.get("visible") === true && layer.get("title") && layer instanceof ol.layer.Vector) {
				// Get all vector features close to click
				var pixel = app.map.getEventPixel(event.originalEvent);
				var foundFeatures = app.map.getFeaturesAtPixel(pixel,{
					hitTolerance: 10, 
					layerFilter: function(l) { 
						if (ol.util.getUid(l) == ol.util.getUid(layer)) return true; else return false;
					}
				});

				// Convert returned features into a format similar to what GetFeatureInfo returns (so we can use the same aggregator function)
				var cf = [];
				$.each(foundFeatures, function(index, feature) {
					
					// Cluster vector layer
					if (feature.get("features")) {
						$.each(feature.get("features"), function(index2, clusterFeature) {
							var f = {};
							f.type = "Feature";
							f.id = clusterFeature.getId();
							f.geometry_name = clusterFeature.getGeometryName();
							f.geometry = {};
							f.geometry.type = clusterFeature.getGeometry().getType();
							f.geometry.coordinates = clusterFeature.getGeometry().getCoordinates();
							f.properties = clusterFeature.getProperties();
							cf.push(f);
						});
					
					// Non cluster vector layer
					} else {
						var f = {};
						f.type = "Feature";
						f.id = feature.getId();
						f.geometry_name = feature.getGeometryName();
						f.geometry = {};
						f.geometry.type = feature.getGeometry().getType();
						
						// Some KML/KMZ (especially those produced from GeoServer) have multi-geometry.  If this is the case, get the first feature (TODO: Improve)
						if (typeof feature.getGeometry().getGeometries === "function") {
							f.geometry.coordinates = feature.getGeometry().getGeometries()[0].getCoordinates();
						
						// Fallback to the generic
						} else {
							f.geometry.coordinates = feature.getGeometry().getCoordinates();
						}
						
						f.properties = feature.getProperties();
						cf.push(f);
					}

				});
				callback(layer, cf);
			}
			
			// WMS :: Perform a GetFeatureInfo
			if (layer.get("visible") === true && typeof layer.getSource().getFeatureInfoUrl == "function") {
				// Build the request url
				var gfiUrl = layer.getSource().getFeatureInfoUrl(
					event.coordinate,
					app.map.getView().getResolution(),
					app.map.getView().getProjection().getCode(),
					{
						"INFO_FORMAT": "application/json",
						"FEATURE_COUNT": app.plugins.CRTIdentify2Popup.pcfg.maxResults
					}
				);
						
				// Define request timeout
				var requestTimeout = (app.plugins.CRTIdentify2Popup.pcfg.requestTimeout) ? app.plugins.CRTIdentify2Popup.pcfg.requestTimeout : 5000;
						
				// Issue the request
				$.ajax({
					type: "GET",
					url: gfiUrl,
					dataType: "json",
					timeout: requestTimeout,
					xhrFields: {
						withCredentials: (layer.get("withCredentials")) ? layer.get("withCredentials") : false
					}
				})
				
				// Handle the response
				.done(function(response) {
					callback(layer, response.features);
				})
				
				// Handle a failure
				.fail(function(jqxhr, settings, exception) {
					callback(layer, []);
					logger("ERROR", "I2P: Error querying " + layer.get("title") + " - " + exception);
				});
			}
			
		});
	}

	/**
	 * Function: adjustPopupContent
	 * @param () none
	 * @returns () nothing
	 * Function to adjust popup content dimensions
	 */
	adjustPopupContent() {
		app.plugins.CRTIdentify2Popup.popupContent.find(".ci2p-feature-table tbody").css("max-height", (app.popupMaxHeight - 95)+"px");
	}
		
	/**
	 * Function: addPlugin
	 * @param () none
	 * @returns () nothing
	 * Function that adds the plugin tab to the sidebar
	 */
	addPlugin() {
		// Define Callback
		var callback = function(success, content){
			// Bail if failed
			if (!success) {
				logger("ERROR", app.plugins.CRTIdentify2Popup.name + ": Plugin failed to initialize");
				return;
			}
			
			// Set the feature template variable to the returned html content
			app.plugins.CRTIdentify2Popup.featureTemplate = $(content);
			
			// Register window height listener that makes adjustments popup content dimensions
			$(window).resize(function() {
				app.plugins.CRTIdentify2Popup.adjustPopupContent();
			});
		
			// Register this plugin as the default map single click function
			registerDefaultMapSingleClickFunction("default", app.plugins.CRTIdentify2Popup.identify);

			// Log success
			logger("INFO", app.plugins.CRTIdentify2Popup.name + ": Plugin successfully loaded");
		}
		
		// Load the feature template
		loadTemplate(this.featureTemplateFile, callback);
	}
}